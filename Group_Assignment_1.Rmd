---
title: 'Finance Group Assignment 1'
author: "Study Group 1"
date: "`r Sys.Date()`"
output: 
    html_document:
      number_sections: true
      highlight: haddock
      theme: spacelab
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, load_libraries, include = FALSE}

library(tidyverse)
library(ggplot2)  
library(here)
library(janitor) # clean_names()
library(skimr)
library(vroom)
library(mosaic)
library(lubridate)
library(readxl)
library(quantmod)
library(xts)
library(moments)

```


# Question 1
```{r load data & cleansing}
# load monthly data & cleansing
PS1_Monthly <- read_excel("PS1_Monthly.xlsx")

PS1_Monthly <- PS1_Monthly %>% 
  mutate(clean_company = ifelse(COMNAM == "CHASE MANHATTAN CORP NEW", "JPM",
                    ifelse(COMNAM == "CHEMICAL BANKING CORP", "JPM",
                    ifelse(COMNAM == "CITIGROUP INC", "CITI",
                    ifelse(COMNAM == "EXXON CORP", "EXXON MOBIL", 
                    ifelse(COMNAM == "EXXON MOBIL CORP", "EXXON MOBIL",
                    ifelse(COMNAM == "GENERAL ELECTRIC CO", "GENERAL ELECTRIC",
                    ifelse(COMNAM == "INTEL CORP", "INTEL",
                    ifelse(COMNAM == "J P MORGAN CHASE & CO", "JPM",
                    ifelse(COMNAM == "JPMORGAN CHASE & CO", "JPM",
                    ifelse(COMNAM == "MICROSOFT CORP", "MICROSOFT",
                    ifelse(COMNAM == "PRIMERICA CORP NEW", "CITI",
                    ifelse(COMNAM == "TRAVELERS GROUP INC", "CITI",
                    ifelse(COMNAM == "TRAVELERS INC", "CITI", "no"))))))))))))))

PS1_Monthly <- PS1_Monthly %>% 
  mutate(date= as.Date(as.character(PS1_Monthly$date), format = "%Y%m%d"))

```


# Question 2
```{r calculate total returns}
PS1_Monthly <-PS1_Monthly %>% 
  group_by(clean_company) %>% 
  mutate(gross_RET = RET+1,
         gross_RETX = RETX+1,
         gross_sprtrn = sprtrn +1)

# calculate total returns which is also cumulative product of gross returns
PS1_Monthly <- PS1_Monthly %>% 
  group_by(clean_company) %>% 
  mutate(tot_RET = cumprod(gross_RET),
         tot_RETX = cumprod(gross_RETX),
         tot_sprtrn = cumprod(gross_sprtrn))

```


```{r plot}
# names <- c("GENERAL ELECTRIC","MICROSOFT")

# plot investment with & without dividend
PS1_Monthly %>% 
  filter(clean_company == "MICROSOFT") %>% 
  ggplot() + 
  geom_line(aes(x=date, y=tot_RET), color='red') +
  geom_line(aes(x=date, y=tot_RETX), color='blue') +
  labs(title = 'Investment on Microsoft with/without dividend',
       subtitle = 'Red line for one with dividend and blue for without',
       y = 'cumulative return') +
   geom_line(aes(x=date, y=tot_sprtrn)) +
  NULL

PS1_Monthly %>% 
  filter(clean_company == "GENERAL ELECTRIC") %>% 
  ggplot() + 
  geom_line(aes(x=date, y=tot_RET), color='red') +
  geom_line(aes(x=date, y=tot_RETX), color='blue') +
  labs(title = 'Investment on GE with/without dividend',
       subtitle = 'Red line for one with dividend and blue for without',
       y = 'cumulative return') +
  geom_line(aes(x=date, y=tot_sprtrn)) +
  NULL
```

Commentary:
From the graphs above we can see that dividends may reduce the profit you could have obtained from the one with dividend payments.

# Question 3
```{r}
# PS1_Monthly <- PS1_Monthly %>%  
#   mutate(LRET = log(abs(RET)))

# generate log return variable
PS1_Monthly <- PS1_Monthly %>%  
  mutate(LRET = log(RET + 1)) #log return should be this according to prof

# calculate metrics of normal and log return
PS1_Monthly %>% 
  select(c(RET,LRET)) %>% 
  summarize(mean_RET = mean(RET),
            mean_LRET = mean(LRET),
            var_RET = var(RET),
            var_LRET = var(LRET),
            skew_RET = skewness(RET),
            skew_LRET = skewness(LRET),
            kurt_RET = kurtosis(RET),
            kurt_LRET = kurtosis(LRET))
                                            
# plot normal return VS log return for Microsoft
PS1_Monthly %>% 
  filter(clean_company == "MICROSOFT") %>% 
  ggplot() + 
  geom_line(aes(x=date, y=RET), color='red') +
  geom_line(aes(x=date, y=LRET), color='yellow') +
  labs(title = 'Normal return VS log return for Microsoft',
       subtitle = 'Red line for normal return and yellow for log return',
       y = 'return') +
  NULL

```

Discussion on the result:
The two types of return nearly overlapped!
not finished, still open to discussion

# Question 4 & 5
```{r}
# load daily data
HPR_daily <- read_excel("PS1_Daily.xlsx", sheet = 'HPR_daily', skip = 1)

# calculate total return for MS, GE and SP500
HPR_daily <- HPR_daily %>% 
  clean_names() %>% 
  mutate(tot_RET_MS = cumprod(msft+1),
         tot_RET_GE = cumprod(ge+1),
         tot_RET_JPM = cumprod(jpm+1),
         tot_sprtrn = cumprod(sprtrn+1))

# plot daily total return for MS, GE and SP500
HPR_daily %>% 
  pivot_longer(cols = 10:12, 
               names_to = 'stocks', 
               values_to = 'total_return') %>% 
  ggplot(aes(date, total_return, color=stocks)) +
  geom_line(aes(group=stocks)) +
  NULL

```

Discussion on results compared with monthly data:
to be finished

# Question 6
```{r}
# generate log return variable
HPR_daily <- HPR_daily %>% 
  pivot_longer(cols = 2:9,
               names_to = 'stocks',
               values_to = 'RET') %>% 
  group_by(stocks) %>% 
  mutate(LRET = log(RET + 1))

# calculate metrics for daily data
HPR_daily %>% 
  select(c(RET,LRET)) %>% 
  summarize(mean_RET = mean(RET),
            mean_LRET = mean(LRET),
            var_RET = var(RET),
            var_LRET = var(LRET),
            skew_RET = skewness(RET),
            skew_LRET = skewness(LRET),
            kurt_RET = kurtosis(RET),
            kurt_LRET = kurtosis(LRET))


```

Discussion on results compared with monthly metrics:
to be finished

# Question 7
```{r}
# statistical properties of daily log return
HPR_daily %>% 
  select(LRET) %>%
  filter(stocks == "msft") %>%
  summarize(mean_LRET_D = mean(LRET),
            var_LRET_D = var(LRET),
            skew_LRET_D = skewness(LRET),
            kurt_LRET_D = kurtosis(LRET))

# statistical properties of daily log return
PS1_Monthly %>% 
  filter(TICKER == 'MSFT') %>% 
  summarize(mean_LRET_M = mean(LRET),
            var_LRET_M = var(LRET),
            skew_LRET_M = skewness(LRET),
            kurt_LRET_M = kurtosis(LRET))

# plot histogram
HPR_daily %>% 
  select(LRET) %>% 
  ggplot() + geom_histogram(aes(x = LRET))

PS1_Monthly %>% 
  select(LRET) %>% 
  ggplot() + geom_histogram(aes(x = LRET))

```

Comment on histograms:
tbf

# Question 8 & 9
```{r}
data <- read_excel("PS1_Daily.xlsx", sheet = 'HPR_daily', skip = 1) %>%
  clean_names()

# covariance matrix for log returns
LR.msft <- log(data$msft + 1)
LR.jpm <- log(data$jpm + 1)
LR.ge <- log(data$ge + 1)
LR.sp <- log(data$sprtrn + 1)
LR <- cbind(LR.msft, LR.jpm, LR.ge, LR.sp)
cov(LR)

# covariance matrix for log returns squared
LR2.msft <- log(data$msft ^ 2 + 1)
LR2.jpm <- log(data$jpm ^ 2 + 1)
LR2.ge <- log(data$ge ^ 2 + 1)
LR2.sp <- log(data$sprtrn ^ 2 + 1)
LR2 <- cbind(LR2.msft, LR2.jpm, LR2.ge, LR2.sp)
cov(LR2)
```

Discussion on results:
tbf

# Question 10
```{r}
# acf for returns
acf(data[, c(2, 4, 5, 9)])

# acf for return squared
acf(data[, c(2, 4, 5, 9)] %>% 
      mutate(msft = msft ^ 2, jpm = jpm ^ 2,
             ge = ge ^ 2, sprtrn = sprtrn ^ 2))

# acf for return absolute
acf(data[, c(2, 4, 5, 9)] %>% 
      mutate(msft = abs(msft), jpm = abs(jpm),
             ge = abs(ge), sprtrn = abs(sprtrn)))

```

Discussion on results:
tbf

# Question 11 & 12
```{r}
# randomly generate weights for portfolio
set.seed(1234)
random <- runif(3)
w <- array(random / sum(random), c(3, 1))
print(w)
returns <- as.matrix(data[, c(2, 4, 5)])

# portfolio return time series
ret.p <- returns %*% w

# total return time series on this portfolio
portfolio <- cumprod(ret.p + 1)

```

```{r}
# data preparation for plotting
df <- read_excel("PS1_Daily.xlsx", sheet = 'HPR_daily', skip = 1) %>%
  clean_names() %>% 
  select(c(1, 2, 4, 5)) %>% 
  mutate(msft = cumprod(msft+1),
         ge = cumprod(ge+1),
         jpm = cumprod(jpm+1))
df <- cbind(df, portfolio)
df <- df %>% 
  pivot_longer(cols = 2:5, names_to = 'stock', values_to = 'total_return')

# portfolio vs msft
df %>% 
  filter(stock %in% c('msft', 'portfolio')) %>% 
  ggplot(aes(date, total_return, color = stock)) +
  geom_line(aes(group = stock)) +
  NULL

# portfolio vs jpm
df %>% 
  filter(stock %in% c('jpm', 'portfolio')) %>% 
  ggplot(aes(date, total_return, color = stock)) +
  geom_line(aes(group = stock)) +
  NULL

# portfolio vs ge
df %>% 
  filter(stock %in% c('ge', 'portfolio')) %>% 
  ggplot(aes(date, total_return, color = stock)) +
  geom_line(aes(group = stock)) +
  NULL

```

Discussion on results:
tbf

